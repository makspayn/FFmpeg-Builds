name: build-win64-nonfree
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    # GH hosted обычно ограничен ~6 часов, оставляем запас
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Ensure Docker available
        run: |
          docker version

      - name: Pull prebuilt base image (avoid makeimage)
        run: |
          docker pull ghcr.io/btbn/ffmpeg-builds/base-win64:latest

      - name: Run build.sh inside container (win64 nonfree)
        run: |
          # монтируем код в /work; build.sh положит артефакты в artifacts/
          docker run --rm \
            -v "${{ github.workspace }}":/work \
            -w /work \
            ghcr.io/btbn/ffmpeg-builds/base-win64:latest \
            /bin/bash -lc "./build.sh win64 nonfree"

      - name: List artifacts
        run: ls -la artifacts || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-win64-nonfree
          path: artifacts/*.zip
